<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Energy Band Gap Simulation</title>
<style>
:root {
  --primary:#4b1d7f;
  --accent:#ff9f1c;
  --green:#2ca58d;
  --blue:#118ab2;
  --yellow:#f0b429;
  --red:#d14343;
  --text:#0f1724;
  --bg:#f5f7fd;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,Arial,sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}
header{background:linear-gradient(90deg, #e3dfff, #f3f5ff);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid var(--primary);}
header h1{color:var(--primary);font-size:22px;font-weight:700;}
.main-container{flex:1;display:grid;grid-template-columns:280px 1fr 150px;gap:12px;padding:12px;}
.left-panel{background:#fff;border-radius:12px;padding:15px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 20px rgba(0,0,0,0.05);max-height:100%;overflow-y:auto;}
.left-panel h2{color:var(--primary);margin-bottom:6px;font-size:16px;}
.step-card{background:var(--primary);color:#fff;border-radius:8px;padding:10px;font-size:14px;font-weight:600;text-align:center;}
.controls{display:flex;flex-direction:column;gap:10px}
.btn{padding:10px;border:none;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.08);transition:0.2s}
.btn:hover{transform:translateY(-2px)}
.btn.green{background:#dff6e8;color:var(--green);}
.btn.blue{background:#d1eefb;color:var(--blue);}
.btn.yellow{background:#fff1d1;color:var(--yellow);}
.btn.red{background:#ffd6d6;color:var(--red);}
.center{background:#ffffff;border-radius:12px;padding:10px;position:relative;overflow-y:auto;overflow-x:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.05);display:flex;flex-direction:column;}
.workspace{width:100%;height:500px;margin:12px auto;border-radius:6px;position:relative;overflow:hidden;}
.apparatus{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:6px;border-radius:12px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.08);min-width:80px;min-height:56px;cursor:grab;user-select:none;}
.apparatus img {max-width:200px;max-height:70px;}
.apparatus[data-name="Container"] img {max-width:250px;max-height:180px;}
.apparatus[data-name="Setup Complete"] img,
.apparatus[data-name="Experiment Complete"] img {max-width:300px;max-height:200px;}
#workspaceStatus{margin-top:6px;font-size:14px;color:#0f1724;text-align:center;}

/* connection dots */
.connector {
  position:absolute;
  width:12px;
  height:12px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 4px rgba(0,0,0,0.3);
  cursor:pointer;
}
.connector.left {
  left:-7px; top:50%; transform:translateY(-50%);
  background:var(--red);
}
.connector.right {
  right:-7px; top:50%; transform:translateY(-50%);
  background:var(--blue);
}
</style>
</head>
<body>
<header>
  <h1>Energy Band Gap Simulation</h1>
</header>

<div class="main-container">
  <!-- Left panel -->
  <aside class="left-panel">
    <div class="step-card" id="stepInfo">Step 1: Place container & light burner. Position diode.</div>
    <h2>Controls</h2>
    <div class="controls">
      <button class="btn blue" id="placeContainerBtn">Place Container</button>
      <button class="btn blue" id="pnBtn">P-N Diode</button>
      <button class="btn blue" id="batteryBtn">Battery</button>
      <button class="btn blue" id="ammeterBtn">Ammeter</button>
      <button class="btn blue" id="voltmeterBtn">Voltmeter</button>
      <button class="btn blue" id="thermoBtn">Thermometer</button>
      <button class="btn yellow" id="connectBtn">Connect</button>
      <button class="btn red" id="undoBtn">Undo</button>
      <!-- NEW UNDO WIRE BUTTON -->
      <button class="btn red" id="undoWireBtn">Undo Wire</button>
    </div>
  </aside>

  <!-- Center workspace -->
  <main class="center">
    <div class="workspace" id="workspace">
      <svg id="connections" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></svg>
    </div>
    <div id="workspaceStatus">Voltage: 0 V | Temperature: 25 Â°C</div>
  </main>
</div>

<script>
const workspace = document.getElementById("workspace");
const statusEl = document.getElementById("workspaceStatus");
const svg = document.getElementById("connections");
let appIndex = 0;
let apps = {};
let history = [];

/* Function to create apparatus */
function createApp(name, imgUrl) {
  const id = `app-${++appIndex}`;
  const el = document.createElement("div");
  el.className = "apparatus";
  el.dataset.id = id;
  el.dataset.name = name;

  if (name === "Voltmeter" || name === "Ammeter") {
    const label = document.createElement("div");
    label.textContent = name;
    label.style.fontSize = "12px";
    label.style.fontWeight = "700";
    label.style.color = "var(--primary)";
    label.style.marginBottom = "4px";
    label.style.textAlign = "center";

    const box = document.createElement("div");
    box.textContent = "0";
    box.style.width = "60px";
    box.style.height = "30px";
    box.style.background = "#f9fafb";
    box.style.border = "2px solid var(--primary)";
    box.style.borderRadius = "6px";
    box.style.display = "flex";
    box.style.alignItems = "center";
    box.style.justifyContent = "center";
    box.style.fontWeight = "600";
    box.style.color = "var(--text)";
    box.className = "display-box";

    el.appendChild(label);
    el.appendChild(box);
  } else {
    const img = document.createElement("img");
    img.src = imgUrl;
    img.alt = name;
    el.appendChild(img);
  }

  // Add connectors
  if (["Battery", "Ammeter", "Voltmeter", "Thermometer", "Experiment Complete"].includes(name)) {
    const leftDot = document.createElement("div");
    leftDot.className = "connector left";
    const rightDot = document.createElement("div");
    rightDot.className = "connector right";
    el.appendChild(leftDot);
    el.appendChild(rightDot);

    [leftDot, rightDot].forEach(dot => 
      dot.addEventListener("mousedown", (e) => handleConnectorClick(dot, e))
    );
  }

  el.style.left = 100 + appIndex * 20 + "px";
  el.style.top = 100 + appIndex * 20 + "px";

  makeDraggable(el);
  workspace.appendChild(el);
  apps[id] = el;
  history.push({ type: "add", id, el });
  return el;
}

/* Draggable logic */
function makeDraggable(el) {
  let offsetX, offsetY, isDown = false;
  el.addEventListener("mousedown", (e) => {
    if (e.target.classList.contains("connector")) return;
    isDown = true;
    const rect = el.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    el.style.zIndex = 1000;
  });
  window.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    const wsRect = workspace.getBoundingClientRect();
    el.style.left = e.clientX - wsRect.left - offsetX + "px";
    el.style.top  = e.clientY - wsRect.top - offsetY + "px";
    updateLines(); // keep wires attached
  });
  window.addEventListener("mouseup", () => {
    if (isDown) checkMerge(el);
    isDown = false;
    el.style.zIndex = 1;
  });
}

/* Overlap detection */
function isOverlapping(el1, el2) {
  const r1 = el1.getBoundingClientRect();
  const r2 = el2.getBoundingClientRect();
  return !(r1.top > r2.bottom || r1.bottom < r2.top || r1.left > r2.right || r1.right < r2.left);
}

/* Merge logic */
function checkMerge(el) {
  Object.values(apps).forEach(other => {
    if (other === el) return;
    if (isOverlapping(el, other)) {
      const n1 = el.dataset.name, n2 = other.dataset.name;
      if ((n1==="Container"&&n2==="P-N Diode")||(n1==="P-N Diode"&&n2==="Container"))
        mergeApps(el, other, "Setup Complete", "images/pic1.png");
      if ((n1==="Setup Complete"&&n2==="Thermometer")||(n1==="Thermometer"&&n2==="Setup Complete"))
        mergeApps(el, other, "Experiment Complete", "images/therinbeak.png");
    }
  });
}

function mergeApps(el1, el2, newName, newImg) {
  workspace.removeChild(el1);
  workspace.removeChild(el2);
  delete apps[el1.dataset.id];
  delete apps[el2.dataset.id];
  const newEl = createApp(newName, newImg);
  statusEl.textContent = `${newName} created!`;
}

/* --- Wire System --- */
let activePath = null;
let pathPoints = [];
let startConnector = null;
let connections = [];

function getConnectorPos(dot){
  const r=dot.getBoundingClientRect(),ws=workspace.getBoundingClientRect();
  return {x:r.left-ws.left+r.width/2,y:r.top-ws.top+r.height/2};
}

function handleConnectorClick(dot,e){
  if(e.button!==0) return; // only left click

  if(!activePath){
    // Start new wire
    startConnector = dot;
    const pos = getConnectorPos(dot);
    pathPoints = [pos];
    activePath = document.createElementNS("http://www.w3.org/2000/svg","polyline");
    activePath.setAttribute("fill","none");
    activePath.setAttribute("stroke","black");
    activePath.setAttribute("stroke-width","2");
    svg.appendChild(activePath);
    updateActivePath(pos);
    window.addEventListener("mousemove", followCursor);
    workspace.addEventListener("mousedown", addBend);
  } else {
    // Finalize connection
    if(dot!==startConnector){
      const pos = getConnectorPos(dot);
      pathPoints.push(pos);
      updateActivePath(pos);

      connections.push({
        line: activePath,
        dot1: startConnector,
        dot2: dot,
        bends: [...pathPoints]
      });

      activePath = null;
      pathPoints = [];
      startConnector = null;
      window.removeEventListener("mousemove", followCursor);
      workspace.removeEventListener("mousedown", addBend);
    }
  }
}

function followCursor(e){
  const wsRect=workspace.getBoundingClientRect();
  const pos={x:e.clientX-wsRect.left,y:e.clientY-wsRect.top};
  updateActivePath(pos);
}

function addBend(e){
  if(e.button!==0) return;
  if(!activePath) return;
  const wsRect=workspace.getBoundingClientRect();
  const pos={x:e.clientX-wsRect.left,y:e.clientY-wsRect.top};
  const last=pathPoints[pathPoints.length-1];
  const bend={x:pos.x,y:last.y};
  pathPoints.push(bend);
  pathPoints.push(pos);
  updateActivePath(pos);
}

function updateActivePath(cursorPos){
  if(!activePath) return;
  const pts=[...pathPoints,cursorPos].map(p=>`${p.x},${p.y}`).join(" ");
  activePath.setAttribute("points",pts);
}

/* Update lines with apparatus movement */
function updateLines(){
  connections.forEach(conn=>{
    const p1=getConnectorPos(conn.dot1);
    const p2=getConnectorPos(conn.dot2);
    const bends=[p1,...conn.bends.slice(1,-1),p2];
    const pts=bends.map(p=>`${p.x},${p.y}`).join(" ");
    conn.line.setAttribute("points",pts);
  });
}

/* Undo last apparatus */
function undoLast(){
  const last=history.pop();if(!last)return;
  if(last.type==="add"){const el=apps[last.id];if(el)workspace.removeChild(el);delete apps[last.id];}
}

/* Undo last wire */
function undoLastWire(){
  if (connections.length === 0) return;
  const lastConn = connections.pop();
  if (lastConn && lastConn.line) {
    svg.removeChild(lastConn.line);
  }
}


/* Buttons */
document.getElementById("placeContainerBtn").addEventListener("click",()=>createApp("Container","images/PIC0.png"));
document.getElementById("pnBtn").addEventListener("click",()=>createApp("P-N Diode","https://flaviocopes.com/images/electronics-components-diodes/Screen_Shot_2020-12-06_at_11.54.39.png"));
document.getElementById("batteryBtn").addEventListener("click",()=>createApp("Battery","images/battery.png"));
document.getElementById("ammeterBtn").addEventListener("click",()=>createApp("Ammeter"));
document.getElementById("voltmeterBtn").addEventListener("click",()=>createApp("Voltmeter"));
document.getElementById("thermoBtn").addEventListener("click",()=>createApp("Thermometer","images/thermo.png"));
document.getElementById("undoBtn").addEventListener("click",undoLast);
document.getElementById("undoWireBtn").addEventListener("click",undoLastWire);

// Add connectors
if (["Battery", "Ammeter", "Voltmeter", "Thermometer", "Experiment Complete"].includes(name)) {
  const leftDot = document.createElement("div");
  const rightDot = document.createElement("div");

  // Special case for Experiment Complete (thermometer in beaker)
  if (name === "Experiment Complete") {
    leftDot.className = "connector left";
    leftDot.style.background = "var(--blue)"; // left = blue
    rightDot.className = "connector right";
    rightDot.style.background = "var(--red)"; // right = red
  } else {
    leftDot.className = "connector left";   // default left = red
    rightDot.className = "connector right"; // default right = blue
  }

  el.appendChild(leftDot);
  el.appendChild(rightDot);

  [leftDot, rightDot].forEach(dot =>
    dot.addEventListener("mousedown", (e) => handleConnectorClick(dot, e))
  );
}

</script>

</body>
</html>
