<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Energy Band Gap Simulation</title>
<style>
:root {
  --primary:#4b1d7f;
  --accent:#ff9f1c;
  --green:#2ca58d;
  --blue:#118ab2;
  --yellow:#f0b429;
  --red:#d14343;
  --text:#0f1724;
  --bg:#f5f7fd;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,Arial,sans-serif}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}
header{background:linear-gradient(90deg, #e3dfff, #f3f5ff);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid var(--primary);}
header h1{color:var(--primary);font-size:22px;font-weight:700;}
.main-container{flex:1;display:grid;grid-template-columns:280px 1fr 150px;gap:12px;padding:12px;}
.left-panel{background:#fff;border-radius:12px;padding:15px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 20px rgba(0,0,0,0.05);max-height:100%;overflow-y:auto;}
.left-panel h2{color:var(--primary);margin-bottom:6px;font-size:16px;}
.step-card{background:var(--primary);color:#fff;border-radius:8px;padding:10px;font-size:14px;font-weight:600;text-align:center;}
.controls{display:flex;flex-direction:column;gap:10px}
.btn{padding:10px;border:none;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.08);transition:0.2s}
.btn:hover{transform:translateY(-2px)}
.btn.green{background:#dff6e8;color:var(--green);}
.btn.blue{background:#d1eefb;color:var(--blue);}
.btn.yellow{background:#fff1d1;color:var(--yellow);}
.btn.red{background:#ffd6d6;color:var(--red);}
.center{background:#ffffff;border-radius:12px;padding:10px;position:relative;overflow-y:auto;overflow-x:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.05);display:flex;flex-direction:column;}
.workspace{width:100%;height:500px;margin:12px auto;border-radius:6px;position:relative;overflow:hidden;}
.apparatus{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:6px;border-radius:12px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.08);min-width:80px;min-height:56px;cursor:grab;user-select:none;}
.apparatus img {max-width:200px;max-height:70px;}
.apparatus[data-name="Container"] img {max-width:250px;max-height:180px;}
.apparatus[data-name="Setup Complete"] img,
.apparatus[data-name="Experiment Complete"] img {max-width:300px;max-height:200px;}
#workspaceStatus{margin-top:6px;font-size:14px;color:#0f1724;text-align:center;}

/* connection dots */
.connector {
  position:absolute;
  width:12px;
  height:12px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 4px rgba(0,0,0,0.3);
  cursor:pointer;
}
.connector.left {
  left:-7px; top:50%; transform:translateY(-50%);
  background:var(--red);
}
.connector.right {
  right:-7px; top:50%; transform:translateY(-50%);
  background:var(--blue);
}

/* LAB BURNER */
.lab-burner {
  width: 60px;
  height: 100px;
  background: #555;
  border-radius: 10px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: 10px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.3);
}
.lab-burner::before { content: ''; width: 10px; height: 25px; background: #333; border-radius: 2px; position: absolute; top: -25px; }
.lab-burner::after { content: ''; width: 40px; height: 10px; background: #222; border-radius: 4px; position: absolute; bottom: -10px; box-shadow: 0 3px 8px rgba(0,0,0,0.4); }
.flame { width: 20px; height: 30px; position: absolute; bottom: 70px; border-radius: 50%; background: radial-gradient(circle, #fffa65 0%, #ff9f1c 40%, #ff3f3f 80%); opacity: 0; animation: flicker 0.4s infinite; transform-origin: bottom center; box-shadow: 0 0 10px rgba(255, 100, 0, 0.7); }
@keyframes flicker {
  0% { transform: scale(1) translateY(0); opacity: 0.9; }
  25% { transform: scale(1.2,1.5) translateY(-3px); opacity: 1; }
  50% { transform: scale(0.9,1.2) translateY(-2px); opacity: 0.8; }
  75% { transform: scale(1.1,1.4) translateY(-4px); opacity: 1; }
  100% { transform: scale(1) translateY(0); opacity: 0.9; }
}
</style>
</head>
<body>
<header>
  <h1>Energy Band Gap Simulation</h1>
</header>

<div class="main-container">
  <aside class="left-panel">
    <div class="step-card" id="stepInfo">Step 1: Place container & light burner. Position diode.</div>
    <h2>Controls</h2>
    <div class="controls">
      <button class="btn blue" id="placeContainerBtn">Place Container</button>
      <button class="btn blue" id="pnBtn">P-N Diode</button>
      <button class="btn blue" id="thermoBtn">Thermometer</button>
      <button class="btn blue" id="batteryBtn">Battery</button>
      <button class="btn blue" id="ammeterBtn">Ammeter</button>
      <button class="btn blue" id="voltmeterBtn">Voltmeter</button>
      <button class="btn red" id="labBurnerBtn">Lab Burner</button>
      <button class="btn green" id="startHeatBtn">Start Heating</button>
       <button class="btn blue" id="startCoolBtn">Start Cooling</button>
      <button class="btn red" id="undoBtn">Undo</button>
      <button class="btn yellow" id="resetWiresBtn">Undo Wires</button>
      <button class="btn green" id="connectBtn">Connect</button>

    </div>
  </aside>

  <main class="center">

    <div class="workspace" id="workspace">
      <svg id="connections" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none"></svg>
    </div>
    <div id="workspaceStatus">Voltage: 5 V | Current: 0.5 A | Temperature: 25 °C</div>
  </main>
</div>
  

<script>
const workspace = document.getElementById("workspace");
const statusEl = document.getElementById("workspaceStatus");
const svg = document.getElementById("connections");
let appIndex = 0, apps = {}, history = [], connections = [], activePath = null, pathPoints = [], startConnector = null;
let temperature = 25, heatingInterval = null, coolingInterval = null, burnerApp = null;

// Correct wiring rules (use parent dataset.name and dot.dataset.type 'left'/'right')
const correctConnections = [
  {from:"Experiment Complete", fromDot:"right", to:"Battery", toDot:"left"},
  {from:"Battery", fromDot:"right", to:"Ammeter", toDot:"right"},
  {from:"Ammeter", fromDot:"left", to:"Experiment Complete", toDot:"left"},
  {from:"Voltmeter", fromDot:"right", to:"Ammeter", toDot:"right"},
  {from:"Voltmeter", fromDot:"left", to:"Battery", toDot:"right"}
];

// Check is wiring is complete or not
function isWiringComplete() {
  return correctConnections.every(c => 
    connections.some(conn => {
      const fromName = conn.dot1.parentElement.dataset.name;
      const toName = conn.dot2.parentElement.dataset.name;
      const fromDot = conn.dot1.dataset.type;
      const toDot = conn.dot2.dataset.type;

      return (
        (c.from === fromName && c.fromDot === fromDot && c.to === toName && c.toDot === toDot) ||
        (c.from === toName && c.fromDot === toDot && c.to === fromName && c.toDot === fromDot)
      );
    })
  );
}


const ammeterReadings = {
  25:3.93,
  30: 6.18,
  35: 9.56,
  40: 14.5,
  45: 21.9,
  50: 32.3,
  55: 46.7,
  60: 66.3,
  65: 92.5,
  70: 127,
  75: 171,
  80: 228
}
function updateAmmeterDisplay(temp) {
  const ammeter = Object.values(apps).find(a => a.dataset.name === "Ammeter");
  if (!ammeter) return;
  const box = ammeter.querySelector(".display-box");
  if (ammeterReadings[temp] !== undefined) {
    box.textContent = ammeterReadings[temp] + " µA";
  } else {
    box.textContent = "0";
  }
}

// --- Voltmeter readings for corresponding temperatures ---
const voltmeterReadings = {
  25: 0.30,
  30: 0.29,
  35: 0.28,
  40: 0.27,
  45: 0.26,
  50: 0.25,
  55: 0.24,
  60: 0.23,
  65: 0.22,
  70: 0.21,
  75: 0.20,
  80: 0.19
};

// Update voltmeter display
function updateVoltmeterDisplay(temp) {
  const voltmeter = Object.values(apps).find(a => a.dataset.name === "Voltmeter");
  if (!voltmeter) return;
  const box = voltmeter.querySelector(".display-box");
  if (voltmeterReadings[temp] !== undefined) {
    box.textContent = voltmeterReadings[temp] + " V";
  } else {
    box.textContent = "0";
  }
}


function createApp(name,imgUrl,withDisplay=false){
  const id = `app-${++appIndex}`;
  const el = document.createElement("div");
  el.className="apparatus";
  el.dataset.id=id;
  el.dataset.name=name;

  if(withDisplay){
    const label = document.createElement("div");
    label.textContent = name;
    label.style.fontSize="12px"; label.style.fontWeight="700";
    label.style.color="var(--primary)"; label.style.marginBottom="4px"; label.style.textAlign="center";

    const box = document.createElement("div");
    box.className="display-box"; box.style.width="100px"; box.style.height="30px"; box.style.background="#f9fafb";
    box.style.border="2px solid var(--primary)"; box.style.borderRadius="6px"; box.style.display="flex";
    box.style.alignItems="center"; box.style.justifyContent="center"; box.style.fontWeight="600"; box.style.color="var(--text)";
    box.textContent = name==="Voltmeter"?"5.0":"0";

    const img = document.createElement("img"); img.src=imgUrl; img.alt=name;

    el.appendChild(label); el.appendChild(box); el.appendChild(img);
  } else {
    const img = document.createElement("img"); img.src=imgUrl; img.alt=name; el.appendChild(img);
  }

  // Only add connectors to relevant apparatus and set data attributes for validation
  if(["Battery","Ammeter","Voltmeter","Thermometer","Experiment Complete","P-N Diode","Container","Setup Complete"].includes(name)){
    const leftDot = document.createElement("div"); leftDot.className="connector left";
    leftDot.dataset.type = "left";
    const rightDot = document.createElement("div"); rightDot.className="connector right";
    rightDot.dataset.type = "right";
    // store parent name accessibly (we already have el.dataset.name so not necessary but keep for clarity)
    leftDot.dataset.parent = name;
    rightDot.dataset.parent = name;

    el.appendChild(leftDot); el.appendChild(rightDot);
    [leftDot,rightDot].forEach(dot=>dot.addEventListener("mousedown", connectorMouseDown));
  }

  // position and make draggable
  el.style.left = 100 + appIndex*20 + "px";
  el.style.top = 100 + appIndex*20 + "px";
  makeDraggable(el);
  workspace.appendChild(el);
  apps[id]=el; history.push({type:"add",id,el});
  return el;
}

// Draggable (unchanged except zIndex reset)
function makeDraggable(el){
  let offsetX,offsetY,isDown=false;
  el.addEventListener("mousedown",(e)=>{
    if(e.target.classList.contains("connector")) return;
    isDown=true;
    const rect=el.getBoundingClientRect();
    offsetX=e.clientX-rect.left; offsetY=e.clientY-rect.top;
    el.style.zIndex=1000;
  });
  window.addEventListener("mousemove",(e)=>{
    if(!isDown) return;
    const wsRect=workspace.getBoundingClientRect();
    el.style.left=e.clientX-wsRect.left-offsetX+"px";
    el.style.top=e.clientY-wsRect.top-offsetY+"px";
    updateLines();
  });
  window.addEventListener("mouseup",()=>{
    if(isDown) checkMerge(el);
    isDown=false;
    el.style.zIndex=1;
  });
}

function isOverlapping(el1,el2){
  const r1=el1.getBoundingClientRect(),r2=el2.getBoundingClientRect();
  return !(r1.top>r2.bottom||r1.bottom<r2.top||r1.left>r2.right||r1.right<r2.left);
}

function checkMerge(el){
  Object.values(apps).forEach(other=>{
    if(other===el) return;
    const n1=el.dataset.name,n2=other.dataset.name;
    if((n1==="Container"&&n2==="P-N Diode")||(n1==="P-N Diode"&&n2==="Container"))
      mergeApps(el,other,"Setup Complete","images/pic1.png");
    if((n1==="Setup Complete"&&n2==="Thermometer")||(n1==="Thermometer"&&n2==="Setup Complete"))
      mergeApps(el,other,"Experiment Complete","images/therinbeak.png");
  });
}

function mergeApps(el1,el2,newName,newImg){
  workspace.removeChild(el1); workspace.removeChild(el2);
  delete apps[el1.dataset.id]; delete apps[el2.dataset.id];
  createApp(newName,newImg);
  statusEl.textContent=`${newName} created!`; statusEl.style.color="green";
}

// ---------- Wiring (single set of functions, fixed) ----------
function connectorMouseDown(e){
  if(e.button !== 0) return;
  const dot = e.target;
  if(!activePath){
    // start a new path
    startConnector = dot;
    pathPoints = [ getConnectorPos(dot) ];
    activePath = document.createElementNS("http://www.w3.org/2000/svg","polyline");
    activePath.setAttribute("fill","none");
    activePath.setAttribute("stroke","black");
    activePath.setAttribute("stroke-width","2");
    svg.appendChild(activePath);
    window.addEventListener("mousemove", followCursor);
    workspace.addEventListener("mousedown", addBend);
  } else if(dot !== startConnector){
    // finish the path - validate connection
    const fromApp = startConnector.parentElement.dataset.name;
    const toApp = dot.parentElement.dataset.name;
    const fromDot = startConnector.dataset.type;
    const toDot = dot.dataset.type;

    const isValid = correctConnections.some(c =>
      (c.from === fromApp && c.fromDot === fromDot && c.to === toApp && c.toDot === toDot) ||
      (c.from === toApp && c.fromDot === toDot && c.to === fromApp && c.toDot === fromDot)
    );

    if(isValid){
      pathPoints.push(getConnectorPos(dot));
      updateActivePath(getConnectorPos(dot));
      connections.push({ line: activePath, dot1: startConnector, dot2: dot, bends: [...pathPoints] });
      
      
      // Allow multiple connections
      startConnector.connections = startConnector.connections || [];
      dot.connections = dot.connections || [];
      startConnector.connections.push(activePath);
      dot.connections.push(activePath);
      
      statusEl.textContent = `Connected: ${fromApp} → ${toApp}`; statusEl.style.color="green";
    } else {
      // invalid - remove path
      if(svg.contains(activePath)) svg.removeChild(activePath);
      statusEl.textContent = `Wrong connection: ${fromApp} → ${toApp}`; statusEl.style.color="red";
    }

    // cleanup
    activePath = null; pathPoints = []; startConnector = null;
    window.removeEventListener("mousemove", followCursor);
    workspace.removeEventListener("mousedown", addBend);
  }
}

function followCursor(e){
  const wsRect = workspace.getBoundingClientRect();
  updateActivePath({ x: e.clientX - wsRect.left, y: e.clientY - wsRect.top });
}

function addBend(e){
  if(e.button !== 0 || !activePath) return;
  const wsRect = workspace.getBoundingClientRect();
  const pos = { x: e.clientX - wsRect.left, y: e.clientY - wsRect.top };
  const last = pathPoints[pathPoints.length - 1] || pos;
  pathPoints.push({ x: pos.x, y: last.y });
  pathPoints.push(pos);
  updateActivePath(pos);
}

function updateActivePath(cursorPos){
  if(!activePath) return;
  const pts = [...pathPoints, cursorPos].map(p => `${p.x},${p.y}`).join(" ");
  activePath.setAttribute("points", pts);
}

function updateLines(){
  connections.forEach(c=>{
    const p1 = getConnectorPos(c.dot1), p2 = getConnectorPos(c.dot2);
    const bends = [p1, ...c.bends.slice(1, -1), p2];
    c.line.setAttribute("points", bends.map(p=>`${p.x},${p.y}`).join(" "));
  });
}

function getConnectorPos(dot){
  const r = dot.getBoundingClientRect(), ws = workspace.getBoundingClientRect();
  return { x: r.left - ws.left + r.width/2, y: r.top - ws.top + r.height/2 };
}

// Undo last (keeps existing behavior)
function undoLast(){
  const last = history.pop();
  
  if(last && last.type === "add"){
    const el = apps[last.id];
    if(el) workspace.removeChild(el);
    delete apps[last.id];
  } else if(!last && burnerApp){
    // If no history left, check for lab burner
    workspace.removeChild(burnerApp.el);
    burnerApp = null;
    statusEl.textContent = "Lab Burner removed!";
    statusEl.style.color = "orange";
  }
}


// --- Button bindings (unchanged) ---
document.getElementById("placeContainerBtn").addEventListener("click",()=>createApp("Container","images/PIC0.png"));
document.getElementById("pnBtn").addEventListener("click",()=>createApp("P-N Diode","https://flaviocopes.com/images/electronics-components-diodes/Screen_Shot_2020-12-06_at_11.54.39.png"));
document.getElementById("batteryBtn").addEventListener("click",()=>createApp("Battery","images/battery.png"));
document.getElementById("ammeterBtn").addEventListener("click",()=>createApp("Ammeter","images/ammeter.png",true));
document.getElementById("voltmeterBtn").addEventListener("click",()=>createApp("Voltmeter","images/voltmeter.png",true));
document.getElementById("thermoBtn").addEventListener("click",()=>createApp("Thermometer","images/thermo.png"));
document.getElementById("undoBtn").addEventListener("click",undoLast);
document.getElementById("resetWiresBtn").addEventListener("click",()=>{
  if(connections.length===0){ statusEl.textContent="No wires to undo!"; return; }
  connections.forEach(c=>{ if(svg.contains(c.line)) svg.removeChild(c.line); });
  connections=[]; statusEl.textContent="All wires removed!"; statusEl.style.color="orange";
});

document.getElementById("labBurnerBtn").addEventListener("click", () => {
    if (burnerApp) return; 
    const burner = document.createElement("div");
    burner.className = "lab-burner";

    const flame = document.createElement("div");
    flame.className = "flame";
    burner.appendChild(flame);

    burner.style.left = "500px";
    burner.style.top = "450px";
    workspace.appendChild(burner);

    burnerApp = { el: burner, flame: flame }; 
    statusEl.textContent = "Lab Burner placed!";
    statusEl.style.color = "green"; 
});

// --- Heating / Cooling Logic ---
const temperatureSteps = [25,30,35,40,45,50,55,60,65,70,75,80];
// Cooling sequence (80 → 25)
const revSteps = [...temperatureSteps].reverse();

function startHeating() {
  if (!burnerApp) { 
    statusEl.textContent = "Place the burner first!"; 
    statusEl.style.color = "red"; 
    return; 
  }

  if (!isWiringComplete()) {
    statusEl.textContent = "Complete all wiring correctly first!";
    statusEl.style.color = "red";
    return;
  }

  clearInterval(coolingInterval);
  burnerApp.flame.style.opacity = 1;
  temperature = 25; 
  let nextIndex = 0;
  clearInterval(heatingInterval);

  heatingInterval = setInterval(() => {
    if (nextIndex < temperatureSteps.length) {
      temperature = temperatureSteps[nextIndex];
      updateAmmeterDisplay(temperature);
      updateVoltmeterDisplay(temperature);
      statusEl.textContent = `Heating... Temperature: ${temperature}°C`;
      nextIndex++;
    } else {
      clearInterval(heatingInterval);
      statusEl.textContent = "Maximum temp reached (80°C)";
    }
  }, 1000);
}

function startCooling() {
  if (!burnerApp) { 
    statusEl.textContent = "Place the burner first!"; 
    statusEl.style.color = "red"; 
    return; 
  }

  if (!isWiringComplete()) {
    statusEl.textContent = "Complete all wiring correctly first!";
    statusEl.style.color = "red";
    return;
  }

  clearInterval(heatingInterval);
  burnerApp.flame.style.opacity = 0;
  temperature = 80; 
  let nextIndex = 0;
  showGraphBtn.disabled = true;
  showGraphBtn.style.opacity = 0.6;

  clearInterval(coolingInterval);
  coolingInterval = setInterval(() => {
    if (nextIndex < revSteps.length) {
      temperature = revSteps[nextIndex];
      updateAmmeterDisplay(temperature);
      updateVoltmeterDisplay(temperature);
      statusEl.textContent = `Cooling... Temperature: ${temperature}°C`;
      nextIndex++;
    } else {
      clearInterval(coolingInterval);
      statusEl.textContent = "Room temp reached (25°C)";
      showGraphBtn.disabled = false;
      showGraphBtn.style.opacity = 1;
    }
  }, 1000);
}



document.getElementById("startHeatBtn").addEventListener("click", startHeating);
document.getElementById("startCoolBtn").addEventListener("click", startCooling);

// --- Steps Section ---
const steps = [
  "Step 1: Place beaker and then insert diode by dragging the image on beaker",
  "Step 2: Now insert the thermometer by dragging it in the beaker",
  "Step 3: Now fix voltmeter, ammeter and battery",
  "Step 4: Connect the right terminal of the diode to the left terminal of the battery.",
  "Step 5: Connect the right terminal of the battery to the right terminal of the ammeter.",
  "Step 6: Connect the left terminal of the ammeter to the left terminal of the diode.",
  "Step 7: Connect the right terminal of the voltmeter to the right terminal of the ammeter.",
  "Step 5: Connect the left terminal of the voltmeter to the right terminal of the battery.",
  "Step 9: Now take readings during heating and cooling."
];

let currentStep = 0;

const rightPanel = document.createElement("aside");
rightPanel.style = `
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  max-height: 100%;
  align-items: center;
  justify-content: center;
`;

const backStepBtn = document.createElement("button");
backStepBtn.className = "btn yellow";
backStepBtn.textContent = "Back Step";

const nextStepBtn = document.createElement("button");
nextStepBtn.className = "btn yellow";
nextStepBtn.textContent = "Next Step";

const showGraphBtn = document.createElement("button");
showGraphBtn.className = "btn green";
showGraphBtn.textContent = "Show Readings / Graphs";
showGraphBtn.disabled = true; // initially disabled
showGraphBtn.style.opacity = 0.6; // optional: visually show disabled
showGraphBtn.addEventListener("click", () => {
  if (!showGraphBtn.disabled) window.location.href = "readings_graphs.html";
});

rightPanel.append(backStepBtn, nextStepBtn, showGraphBtn);
document.querySelector(".main-container").appendChild(rightPanel);

const stepLeftInfo = document.getElementById("stepInfo");

function updateStep(stepIndex) {
  stepLeftInfo.textContent = steps[stepIndex];
  statusEl.textContent = `Now: ${steps[stepIndex]}`;
}

nextStepBtn.addEventListener("click", () => {
  if (currentStep < steps.length - 1) {
    currentStep++;
    updateStep(currentStep);
  }
});

backStepBtn.addEventListener("click", () => {
  if (currentStep > 0) {
    currentStep--;
    updateStep(currentStep);
  }
});


</script>

</body>
</html>
